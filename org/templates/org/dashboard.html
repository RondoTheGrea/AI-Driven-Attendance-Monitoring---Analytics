{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organization Dashboard</title>
    <link rel="stylesheet" href="{% static 'css/base.css' %}">
    <link rel="stylesheet" href="{% static 'css/org-dashboard.css' %}">
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
</head>
<body class="page-dashboard">
    <!-- Sidebar Toggle Button -->
    <div id="sidebartoggle" class="sidebar-toggle-bar">
        <button class="openbtn" onclick="openNav()">☰</button>
    </div>

    <!-- Sidebar -->
    <div id="mySidebar" class="sidebar">
        <!-- Team UMA Header -->
        <div id="teamuma" class="sidebar-header">
            <img src="{% static 'images/ICCT-LOGO.png' %}" alt="ICCT Logo">
            <div id="teamumatext">
                <h1>TEAM UMA;</h1>
                <h1 id="at">Attendance Tracker</h1>
            </div>
        </div>
        
        <!-- Close Button -->
        <a id="closebutton" href="javascript:void(0)" class="closebtn" onclick="closeNav()">☰</a>
        
        <!-- Sidebar Navigation -->
        <a class="sidebl sidebar-item active" 
           href="#" 
           hx-get="{% url 'org-dashboard-overview' %}" 
           hx-target="#content-area" 
           hx-swap="innerHTML">
            Overview
        </a>
        <a class="sidebl sidebar-item" 
           href="#" 
           hx-get="{% url 'org-dashboard-events' %}" 
           hx-target="#content-area" 
           hx-swap="innerHTML">
            Events
        </a>
        <a class="sidebl sidebar-item" 
           href="#" 
           hx-get="{% url 'org-dashboard-insights' %}" 
           hx-target="#content-area" 
           hx-swap="innerHTML">
            AI Insights
        </a>
        <a class="sidebl sidebar-item" 
           href="#" 
           hx-get="{% url 'org-dashboard-settings' %}" 
           hx-target="#content-area" 
           hx-swap="innerHTML">
            Settings
        </a>

        <!-- Logout Button at Bottom -->
        <a class="sidebl sidebar-item logout-btn" 
           href="{% url 'org-logout' %}">
            Logout
        </a>
    </div>

    <!-- Main Content Area -->
    <div id="main">
        <div id="content-area">
            <!-- Content will be loaded here via HTMX -->
        </div>
    </div>

    <script>
        let liveEventSource = null;

        /* Set the width of the sidebar to 20vw and adjust layout */
        function openNav() {
            document.getElementById("mySidebar").style.width = "20vw";
            document.getElementById("main").style.marginLeft = "18vw";
        }

        /* Set the width of the sidebar to 0 */
        function closeNav() {
            document.getElementById("mySidebar").style.width = "0";
            document.getElementById("main").style.marginLeft = "0";
        }

        // Initialize or tear down the live attendance SSE stream
        function initLiveAttendanceStream(root) {
            // Close any previous stream
            if (liveEventSource) {
                liveEventSource.close();
                liveEventSource = null;
            }

            if (!root) {
                return;
            }

            const feedContainer = root.querySelector('#attendance-feed');
            if (!feedContainer) {
                return;
            }

            const eventId = feedContainer.getAttribute('data-event-id');
            if (!eventId) {
                return;
            }

            const sseUrl = `/org/api/attendance-stream/${eventId}/`;
            const eventSource = new EventSource(sseUrl);
            liveEventSource = eventSource;

            eventSource.addEventListener('message', function (e) {
                try {
                    const data = JSON.parse(e.data);

                    // Skip establishment message
                    if (data.student_name === 'Connection established') {
                        return;
                    }

                    const item = document.createElement('div');
                    item.className = 'feed-item';
                    item.innerHTML = `
                        <div class="feed-time">${data.timestamp}</div>
                        <div class="feed-info">
                            <strong>${data.student_name}</strong>
                            <span class="feed-note">Checked in</span>
                        </div>
                    `;
                    feedContainer.insertBefore(item, feedContainer.firstChild);

                    while (feedContainer.children.length > 50) {
                        feedContainer.removeChild(feedContainer.lastChild);
                    }
                } catch (err) {
                    console.error('Error parsing SSE data:', err);
                }
            }, false);
        }

        // Set active sidebar item on click
        document.querySelectorAll('.sidebar-item').forEach(item => {
            item.addEventListener('click', function(e) {
                // Don't prevent default for logout
                if (this.classList.contains('logout-btn')) {
                    return;
                }
                e.preventDefault();
                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                this.classList.add('active');
                htmx.ajax('GET', this.getAttribute('hx-get'), {target: '#content-area', swap: 'innerHTML'});
            });
        });

        // Listen for HTMX swaps to reinitialize chat interface and live attendance
        document.body.addEventListener('htmx:afterSwap', function(event) {
            if (event.detail.target.id === 'content-area') {
                const chatMessages = event.detail.target.querySelector('#chatMessages');
                if (chatMessages) {
                    console.log('Insights tab loaded, chat should initialize...');
                }

                // Initialize live attendance stream if overview content is present
                initLiveAttendanceStream(event.detail.target);
            }
        });

        // Load default overview and open sidebar on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Open the sidebar so tabs are visible immediately
            openNav();

            // Then load the default active tab content
            const defaultTab = document.querySelector('.sidebar-item.active:not(.logout-btn)');
            if (defaultTab) {
                htmx.ajax('GET', defaultTab.getAttribute('hx-get'), {target: '#content-area', swap: 'innerHTML'});
            }
        });
    </script>
</body>
</html>
